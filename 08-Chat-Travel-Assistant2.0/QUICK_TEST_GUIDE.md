# 错误恢复机制快速测试指南

## 🚀 快速测试（推荐）

### 最简单测试：缺少目的地参数

**输入**：
```
帮我查询天气
```

**预期现象**：
1. 打开浏览器开发者工具（F12）
2. 在 Console 中应该看到：
   ```
   [Workflow] 尝试错误恢复，步骤: 1, ...
   [Workflow] 获取到修正后的参数: { destination: "...", ... }
   ```
3. 在"任务规划步骤"面板中应该看到：
   - `步骤 1 执行失败，正在尝试修复参数...`
   - `参数已修正，正在重试步骤 1...`
4. 在"工具执行日志"面板中应该看到：
   - 第一次：`❌ 错误: workflow params 缺少 destination...`
   - 第二次：`✅ 成功: ...`（重试后成功）

---

## 📋 完整测试清单

### 测试 1：缺少 destination（最简单）
```
输入：帮我查询天气
验证：destination 参数被自动添加
```

### 测试 2：缺少 date
```
输入：查询北京的天气
验证：date 参数被自动添加
```

### 测试 3：缺少交通方式
```
输入：帮我规划去上海的旅行，查询天气和打包清单
验证：transportation_preference 参数被自动添加
```

### 测试 4：多个参数缺失
```
输入：旅行规划
验证：所有缺失的参数被一次性修正
```

---

## 🔍 如何判断错误恢复是否生效

### ✅ 成功标志

1. **控制台日志**：
   - `[Workflow] 尝试错误恢复，步骤: X, ...`
   - `[Workflow] 获取到修正后的参数: ...`
   - `参数已修正，正在重试步骤 X...`

2. **UI 显示**：
   - 规划面板显示错误恢复状态
   - 工具执行日志显示重试成功

3. **最终结果**：
   - 工作流成功完成
   - 生成最终答案

### ❌ 失败标志

1. **直接报错**：工作流直接中断，没有尝试恢复
2. **无限循环**：不断重试但一直失败（需要添加重试次数限制）
3. **参数格式错误**：模型返回的参数格式不正确

---

## 🛠️ 调试技巧

### 1. 查看完整日志
在控制台输入：
```javascript
// 查看所有工作流相关日志
console.log('[Workflow]')
```

### 2. 检查网络请求
在 Network 面板中查找：
- 错误恢复请求（调用模型修正参数）
- 工具重试请求

### 3. 验证参数格式
检查模型返回的参数是否符合：
```typescript
{
  destination: string,
  date: string,
  stay_days: number,
  transportation_preference: string
}
```

---

## ⚠️ 常见问题

### Q: 为什么没有触发错误恢复？
A: 检查以下几点：
1. 工具是否真的抛出了错误？
2. `onStepErrorRecovery` 回调是否被正确注册？
3. 错误是否在适配器层被捕获？

### Q: 错误恢复后仍然失败？
A: 可能原因：
1. 模型返回的参数格式不正确
2. 参数验证失败
3. 依赖关系问题未解决

### Q: 如何添加重试次数限制？
A: 可以在 `runWorkflow` 中为每个步骤添加重试计数器。

---

## 📝 测试记录模板

```
测试用例：_______
测试时间：_______
测试输入：_______

结果：
[ ] 错误被捕获
[ ] 错误恢复机制被触发
[ ] 模型返回修正后的参数
[ ] 参数格式验证通过
[ ] 步骤重试成功
[ ] 工作流最终完成

控制台日志：
_______

UI 显示：
_______

备注：
_______
```

