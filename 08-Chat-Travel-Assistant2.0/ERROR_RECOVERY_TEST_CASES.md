# 错误恢复机制测试用例

## 测试目标
验证工具执行错误时，系统能够：
1. 捕获错误并调用恢复机制
2. 通过模型修正参数
3. 自动重试失败的步骤
4. 继续执行工作流

---

## 测试用例 1：缺少 destination 参数

### 测试场景
用户输入一个缺少目的地信息的请求，导致 `weatherTool` 执行失败。

### 测试输入
```
帮我查询天气
```
或者
```
我想知道明天的天气情况
```

### 预期行为
1. **第一步**：模型生成 WorkflowPlan，但 `params.destination` 为空或缺失
2. **第二步**：`weatherToolAdapter` 执行时抛出错误：`"workflow params 缺少 destination，无法调用 weatherTool"`
3. **第三步**：触发错误恢复机制
   - 在控制台看到：`[Workflow] 尝试错误恢复，步骤: 1, ...`
   - 在规划面板看到：`步骤 1 执行失败，正在尝试修复参数...`
4. **第四步**：模型分析错误并返回修正后的参数
   - 模型应该推断出需要添加 `destination` 参数
   - 返回格式：`{ "corrected_params": { "destination": "北京", "date": "明天", ... } }`
5. **第五步**：参数修正后重试
   - 在规划面板看到：`参数已修正，正在重试步骤 1...`
   - `weatherTool` 成功执行
6. **第六步**：工作流继续执行，生成最终答案

### 验证点
- ✅ 控制台有错误恢复日志
- ✅ 规划面板显示错误恢复状态
- ✅ 工具执行日志显示步骤重试
- ✅ 最终工作流成功完成

---

## 测试用例 2：缺少 date 参数

### 测试场景
用户输入缺少日期信息的请求，导致 `weatherTool` 执行失败。

### 测试输入
```
查询北京的天气
```

### 预期行为
1. 模型生成 WorkflowPlan，`params.date` 为空或缺失
2. `weatherToolAdapter` 执行时可能失败（取决于 `date` 的默认值处理）
3. 如果失败，触发错误恢复机制
4. 模型修正参数，添加合理的 `date` 值（如 "今天" 或 "明天"）
5. 重试成功，工作流继续

### 验证点
- ✅ 错误被捕获并恢复
- ✅ `date` 参数被正确修正
- ✅ 步骤重试成功

---

## 测试用例 3：缺少 transportation_preference 参数

### 测试场景
用户输入缺少交通方式信息的请求，导致 `packingListTool` 执行失败。

### 测试输入
```
帮我规划去上海的旅行，查询天气和打包清单
```

### 预期行为
1. 模型生成 WorkflowPlan，但 `params.transportation_preference` 缺失
2. `packingListToolAdapter` 执行时抛出错误：`"packingListTool 需要 transportation_preference 参数"`
3. 触发错误恢复机制
4. 模型修正参数，添加合理的交通方式（如 "飞机"）
5. 重试成功

### 验证点
- ✅ `transportation_preference` 被修正
- ✅ 步骤重试成功
- ✅ 打包清单工具正常执行

---

## 测试用例 4：依赖步骤缺失（travelAdviceTool）

### 测试场景
工作流中 `travelAdviceTool` 依赖 `weatherTool` 的结果，但依赖步骤失败或未执行。

### 测试输入
```
帮我查询北京的天气，然后给出穿衣建议
```

### 预期行为
1. 如果 `weatherTool` 步骤失败，`travelAdviceTool` 会抛出错误：`"travelAdviceTool 需要从依赖步骤获取天气信息"`
2. 触发错误恢复机制
3. 模型分析错误，可能需要：
   - 确保 `weatherTool` 步骤先执行
   - 或者修正 `travelAdviceTool` 的依赖关系
4. 重试成功

### 验证点
- ✅ 依赖关系错误被识别
- ✅ 错误恢复机制正确处理依赖问题
- ✅ 步骤重试后成功

---

## 测试用例 5：无效的交通方式

### 测试场景
用户输入了无效的交通方式，导致参数验证失败。

### 测试输入
```
帮我规划去广州的旅行，交通方式是轮船
```

### 预期行为
1. 模型生成 WorkflowPlan，`params.transportation_preference` 为 "轮船"
2. `packingListToolAdapter` 执行时，由于 "轮船" 不在有效列表中，会使用默认值 "高铁"
3. 如果仍然失败，触发错误恢复机制
4. 模型修正为有效的交通方式

### 验证点
- ✅ 无效参数被识别
- ✅ 参数被修正为有效值
- ✅ 工具正常执行

---

## 测试用例 6：多个参数缺失

### 测试场景
用户输入非常简短的请求，导致多个参数缺失。

### 测试输入
```
旅行规划
```

### 预期行为
1. 模型生成 WorkflowPlan，但多个参数缺失（`destination`、`date`、`transportation_preference` 等）
2. 第一个工具执行失败
3. 触发错误恢复机制
4. 模型一次性修正所有缺失的参数
5. 重试成功

### 验证点
- ✅ 多个参数同时被修正
- ✅ 工作流成功执行

---

## 如何观察测试结果

### 1. 控制台日志
打开浏览器开发者工具，查看 Console，应该看到：
```
[Workflow] 尝试错误恢复，步骤: 1, ...
[Workflow] 获取到修正后的参数: { destination: "...", ... }
```

### 2. 规划面板
在聊天界面的"任务规划步骤"面板中，应该看到：
- `步骤 X 执行失败，正在尝试修复参数...`
- `参数已修正，正在重试步骤 X...`

### 3. 工具执行日志
在"工具执行日志"面板中，应该看到：
- 第一次执行：`❌ 错误: ...`
- 第二次执行（重试）：`✅ 成功: ...`

### 4. 网络请求
在 Network 面板中，应该看到：
- 第一次工具执行失败
- 错误恢复请求（调用模型修正参数）
- 第二次工具执行（重试）

---

## 注意事项

1. **模型响应质量**：错误恢复依赖于模型能够正确理解错误并返回修正后的参数。如果模型返回的格式不正确，恢复会失败。

2. **恢复次数限制**：当前实现没有限制恢复次数，如果模型一直返回错误的参数，可能会无限循环。建议添加最大重试次数限制。

3. **参数验证**：确保修正后的参数符合 `WorkflowParams` 类型定义：
   - `destination`: string
   - `date`: string
   - `stay_days`: number
   - `transportation_preference`: string

4. **依赖关系**：某些工具依赖其他步骤的结果，如果依赖步骤失败，需要确保恢复机制能够正确处理。

---

## 预期测试结果总结

| 测试用例 | 预期结果 | 关键验证点 |
|---------|---------|-----------|
| 用例1：缺少 destination | ✅ 成功恢复 | 参数被修正，步骤重试成功 |
| 用例2：缺少 date | ✅ 成功恢复 | date 参数被添加 |
| 用例3：缺少 transportation_preference | ✅ 成功恢复 | 交通方式被修正 |
| 用例4：依赖步骤缺失 | ✅ 成功恢复 | 依赖关系被正确处理 |
| 用例5：无效交通方式 | ✅ 成功恢复 | 无效值被修正为有效值 |
| 用例6：多个参数缺失 | ✅ 成功恢复 | 所有参数被一次性修正 |

---

## 如果测试失败

如果某个测试用例失败，请检查：

1. **控制台错误**：查看是否有 JavaScript 错误
2. **网络请求**：检查错误恢复请求是否发送成功
3. **模型响应**：检查模型返回的参数格式是否正确
4. **参数验证**：确认修正后的参数是否符合类型定义
5. **依赖关系**：确认步骤依赖关系是否正确设置

